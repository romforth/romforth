# code.prims : mapping from the Forth primitives to native code (m68k assembly)
#
# Copyright (c) 2023 Charles Suresh <romforth@proton.me>
# SPDX-License-Identifier: AGPL-3.0-only
# Please see the LICENSE file for the Affero GPL 3.0 license details

define ip	%a0
define w	%d0
define tos	%d1
define temp	%d7
define sp	%a7

cold	: move.l #rom, ip
next	: move.b (ip)+, w ; jmp next(w)
bye	: move.l #247, w ; move.l #0, tos ; trap #0
dup	: move.l tos, -(sp) ;
drop	: move.l (sp)+, tos ;
key	: dup ; move.l #3, w ; move.l #0, tos ; move.l #buf, %d2 ; move.l #1, %d3 ; trap #0 ; move.b buf, tos ;
emit	: move.b tos, buf ; move.l #4, w ; move.l #1, tos ; move.l #buf, %d2 ; move.l #1, %d3 ; trap #0 ; drop ;
lit	: dup ; move.l (ip)+, tos ;
neg	: neg.l tos ;
jdrop	: drop
j	: move.b (ip)+, temp ; add.l temp, ip ;
jz	: neg.l tos ; bcc jdrop ; add.l #1, ip ;
jnz	: neg.l tos ; bcs jdrop ; add.l #1, ip ;
inc	: add.l #1, tos ;
dec	: sub.l #1, tos ;
inv	: not.l tos ;
