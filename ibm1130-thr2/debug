#!/usr/bin/perl -w
#
# debug : annotate the cpu trace generated by simh to help with debugging
#
# Copyright (c) 2025 Charles Suresh <romforth@proton.me>
# SPDX-License-Identifier: AGPL-3.0-only
# Please see the LICENSE file for the Affero GPL 3.0 license details

# usage: ./debug < foo # where foo is generated by "attach cpu foo" in simh.cmds

# In the generated output, look for the lines beginning with "rom:" which
# denotes the Forth "opcodes" - the native machine code is tagged with "prims:"

# This script hardcodes the address "0136" which might change in the future
# so that needs to be adjusted as necessary.

@ARGV=("forth_defs.lst");
while (<>) {
	if (/^(\S+)/) {
		$hash->{$1}=$_;
	}
}

while (<>) {
	print;
	my ($i,$a,$e,$i1,$i2,$i3,$o)=split;
	if (defined ($h=$hash->{uc($i)})) {
		print "prims: $h";
	}
	if ($i eq "0136") {
		if (defined ($h=$hash->{uc($i1)})) {
			print "rom: $h";
		}
	}
}
